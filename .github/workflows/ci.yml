name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Lint Â· Typecheck Â· Test Â· Build
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20, 22]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate (lint + typecheck + test + build)
        run: pnpm validate

      - name: Check bundle size
        run: |
          BUILD_SIZE=$(du -sk dist/ | cut -f1)
          echo "ğŸ“¦ Total bundle size: ${BUILD_SIZE}KB"

          # Warn if bundle exceeds 500KB
          if [ "$BUILD_SIZE" -gt 500 ]; then
            echo "::warning::Bundle size (${BUILD_SIZE}KB) exceeds 500KB threshold"
          fi

          # List largest files
          echo "ğŸ“Š Largest files:"
          find dist/ -type f -exec du -sk {} \; | sort -rn | head -10

      - name: Accessibility checks
        run: |
          # Check for images without alt in components
          echo "ğŸ” Checking for images without alt..."
          MISSING_ALT=$(grep -rn "<img" src/ --include="*.tsx" | grep -v 'alt=' | wc -l)
          if [ "$MISSING_ALT" -gt 0 ]; then
            echo "::warning::Found $MISSING_ALT images without alt attribute"
            grep -rn "<img" src/ --include="*.tsx" | grep -v 'alt='
          fi

          # Check for inline cursor:none in components (not CSS utility definitions)
          echo "ğŸ” Checking for cursor:none in components..."
          CURSOR_NONE=$(grep -rn "cursor.*none\|cursor-none" src/ --include="*.tsx" | wc -l)
          if [ "$CURSOR_NONE" -gt 0 ]; then
            echo "::warning::Found cursor:none usage in components â€” ensure a custom cursor replacement exists"
            grep -rn "cursor.*none\|cursor-none" src/ --include="*.tsx"
          fi

          # Check CSS files for cursor:none
          echo "ğŸ” Checking for cursor:none in CSS..."
          CURSOR_CSS=$(grep -rn "cursor.*none" src/ --include="*.css" | grep -v "@media" | wc -l)
          if [ "$CURSOR_CSS" -gt 0 ]; then
            echo "::warning::Found cursor:none in CSS files"
            grep -rn "cursor.*none" src/ --include="*.css" | grep -v "@media"
          fi
